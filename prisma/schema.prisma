generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  password           String
  name               String?
  token              Token?
  subscriptions      UserSubscription[]
  eventRegistrations EventRegistration[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model UserSubscription {
  user           User         @relation(fields: [userId], references: [id])
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  role OrganizationRole @default(MEMBER)

  subscribedAt DateTime @default(now())

  @@id([userId, organizationId])
  @@map("user_subscriptions")
}

model Token {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique @map("user_id")
  expiresAt DateTime

  @@map("tokens")
}

enum OrganizationRole {
  MEMBER
  OWNER
}

model Organization {
  id          String             @id @default(uuid())
  name        String             @unique
  description String
  subscribers UserSubscription[]
  events      Event[]
  photo       PublicFile?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("organizations")
}

model EventRegistration {
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId String @map("event_id")
  user    User   @relation(fields: [userId], references: [id])
  userId  String @map("user_id")

  @@id([userId, eventId])
  @@map("event_registrations")
}

model Event {
  id             String              @id @default(uuid())
  name           String              @unique
  description    String
  places         Int
  date           DateTime
  organization   Organization        @relation(fields: [organizationId], references: [id])
  organizationId String              @map("organization_id")
  registrations  EventRegistration[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("events")
}

model PublicFile {
  id             String       @id @default(uuid())
  key            String
  url            String
  urlExpo        String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String       @unique @map("organization_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("public_files")
}
